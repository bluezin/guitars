<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Mtdavid" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Mtdavid">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.jpg" type="image/jpg">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.jpg">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <script
      type="text/javascript"
      src="https://static.micuentaweb.pe/static/js/krypton-client/V4.0/stable/kr-payment-form.min.js"
      kr-public-key="<%= ENV["IZIPAY_PUBLIC_KEY"] %>"
      kr-get-url-success="<%= success_path %>"
      kr-language="es">
    </script>
    <link
      rel="stylesheet"
      href="https://static.micuentaweb.pe/static/js/krypton-client/V4.0/ext/classic-reset.css">
    <script src="https://static.micuentaweb.pe/static/js/krypton-client/V4.0/ext/classic.js"></script>
    </head>
  </head>

  <body>
    <%= render "layouts/nav" %>

    <% if flash[:notice] %>
      <div class="notice">
        <%= flash[:notice] %>
      </div>
    <% end %>

      <div class="alert">
        <%= flash[:alert] %>
      </div>

      <%= yield %>

    <script>
      document.addEventListener("turbo:load", () => {
        const input   = document.getElementById("media_input");
        const preview = document.getElementById("preview");

        if (!input || !preview) return;

        let filesArray = [];

        input.addEventListener("change", (e) => {
          const newFiles = Array.from(e.target.files);
          filesArray = filesArray.concat(newFiles);
          renderPreview();
        });

        function syncInputFiles() {
          const dataTransfer = new DataTransfer();
          filesArray.forEach(file => dataTransfer.items.add(file));
          input.files = dataTransfer.files;
        }

        function renderPreview() {
          preview.innerHTML = "";

          filesArray.forEach((file, index) => {
            const wrapper = document.createElement("div");
            wrapper.style.position = "relative";
            wrapper.style.display = "inline-block";
            wrapper.style.margin = "8px";

            let mediaEl;

            // ðŸ”¥ DIFERENCIAR IMAGEN vs VIDEO
            if (file.type.startsWith("image/")) {
              mediaEl = document.createElement("img");
              mediaEl.src = URL.createObjectURL(file);
            } else if (file.type.startsWith("video/")) {
              mediaEl = document.createElement("video");
              mediaEl.src = URL.createObjectURL(file);
              mediaEl.controls = true;
            } else {
              return; // ignorar otros tipos
            }

            mediaEl.style.width = "140px";
            mediaEl.style.height = "140px";

            const button = document.createElement("button");
            button.textContent = t("common.delete");
            button.type = "button";

            button.addEventListener("click", () => {
              filesArray.splice(index, 1);
              syncInputFiles();
              renderPreview();
            });

            wrapper.appendChild(mediaEl);
            wrapper.appendChild(button);
            preview.appendChild(wrapper);
          });

          syncInputFiles();
        }
      });
    </script>

  </body>
</html>
